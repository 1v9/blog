THREE.SpriteCanvasMaterial=function(parameters){THREE.Material.call(this),this.type="SpriteCanvasMaterial",this.color=new THREE.Color(16777215),this.program=function(context,color){},this.setValues(parameters)},THREE.SpriteCanvasMaterial.prototype=Object.create(THREE.Material.prototype),THREE.SpriteCanvasMaterial.prototype.constructor=THREE.SpriteCanvasMaterial,THREE.SpriteCanvasMaterial.prototype.clone=function(){var material=new THREE.SpriteCanvasMaterial;return material.copy(this),material.color.copy(this.color),material.program=this.program,material},THREE.CanvasRenderer=function(parameters){console.log("THREE.CanvasRenderer",THREE.REVISION),parameters=parameters||{};var _renderData,_elements,_lights,_v1,_v2,_v3,_v1x,_v1y,_v2x,_v2y,_v3x,_v3y,_uvs,_uv1x,_uv1y,_uv2x,_uv2y,_uv3x,_uv3y,_this=this,_projector=new THREE.Projector,_canvas=void 0!==parameters.canvas?parameters.canvas:document.createElement("canvas"),_canvasWidth=_canvas.width,_canvasHeight=_canvas.height,_canvasWidthHalf=Math.floor(_canvasWidth/2),_canvasHeightHalf=Math.floor(_canvasHeight/2),_viewportX=0,_viewportY=0,_viewportWidth=_canvasWidth,_viewportHeight=_canvasHeight,_pixelRatio=1,_context=_canvas.getContext("2d",{alpha:!0===parameters.alpha}),_clearColor=new THREE.Color(0),_clearAlpha=!0===parameters.alpha?0:1,_contextGlobalAlpha=1,_contextGlobalCompositeOperation=0,_contextStrokeStyle=null,_contextFillStyle=null,_contextLineWidth=null,_contextLineCap=null,_contextLineJoin=null,_contextLineDash=[],_color=(new THREE.RenderableVertex,new THREE.RenderableVertex,new THREE.Color),_diffuseColor=(new THREE.Color,new THREE.Color,new THREE.Color,new THREE.Color,new THREE.Color),_emissiveColor=new THREE.Color,_lightColor=new THREE.Color,_patterns={},_clipBox=new THREE.Box2,_clearBox=new THREE.Box2,_elemBox=new THREE.Box2,_ambientLight=new THREE.Color,_directionalLights=new THREE.Color,_pointLights=new THREE.Color,_vector3=new THREE.Vector3,_centroid=new THREE.Vector3,_normal=new THREE.Vector3,_normalViewMatrix=new THREE.Matrix3;function renderSprite(v1,element,material){setOpacity(material.opacity),setBlending(material.blending);var scaleX=element.scale.x*_canvasWidthHalf,scaleY=element.scale.y*_canvasHeightHalf,dist=.5*Math.sqrt(scaleX*scaleX+scaleY*scaleY);if(_elemBox.min.set(v1.x-dist,v1.y-dist),_elemBox.max.set(v1.x+dist,v1.y+dist),material instanceof THREE.SpriteMaterial){var texture=material.map;if(null!==texture){var pattern=_patterns[texture.id];if(void 0!==pattern&&pattern.version===texture.version||(pattern=textureToPattern(texture),_patterns[texture.id]=pattern),void 0!==pattern.canvas){setFillStyle(pattern.canvas);var bitmap=texture.image,ox=bitmap.width*texture.offset.x,oy=bitmap.height*texture.offset.y,sx=bitmap.width*texture.repeat.x,sy=bitmap.height*texture.repeat.y,cx=scaleX/sx,cy=scaleY/sy;_context.save(),_context.translate(v1.x,v1.y),0!==material.rotation&&_context.rotate(material.rotation),_context.translate(-scaleX/2,-scaleY/2),_context.scale(cx,cy),_context.translate(-ox,-oy),_context.fillRect(ox,oy,sx,sy),_context.restore()}}else setFillStyle(material.color.getStyle()),_context.save(),_context.translate(v1.x,v1.y),0!==material.rotation&&_context.rotate(material.rotation),_context.scale(scaleX,-scaleY),_context.fillRect(-.5,-.5,1,1),_context.restore()}else material instanceof THREE.SpriteCanvasMaterial&&(setStrokeStyle(material.color.getStyle()),setFillStyle(material.color.getStyle()),_context.save(),_context.translate(v1.x,v1.y),0!==material.rotation&&_context.rotate(material.rotation),_context.scale(scaleX,scaleY),material.program(_context),_context.restore())}function renderLine(v1,v2,element,material){if(setOpacity(material.opacity),setBlending(material.blending),_context.beginPath(),_context.moveTo(v1.positionScreen.x,v1.positionScreen.y),_context.lineTo(v2.positionScreen.x,v2.positionScreen.y),material instanceof THREE.LineBasicMaterial){if(setLineWidth(material.linewidth),setLineCap(material.linecap),setLineJoin(material.linejoin),material.vertexColors!==THREE.VertexColors)setStrokeStyle(material.color.getStyle());else{var colorStyle1=element.vertexColors[0].getStyle(),colorStyle2=element.vertexColors[1].getStyle();if(colorStyle1===colorStyle2)setStrokeStyle(colorStyle1);else{try{var grad=_context.createLinearGradient(v1.positionScreen.x,v1.positionScreen.y,v2.positionScreen.x,v2.positionScreen.y);grad.addColorStop(0,colorStyle1),grad.addColorStop(1,colorStyle2)}catch(exception){grad=colorStyle1}setStrokeStyle(grad)}}_context.stroke(),_elemBox.expandByScalar(2*material.linewidth)}else material instanceof THREE.LineDashedMaterial&&(setLineWidth(material.linewidth),setLineCap(material.linecap),setLineJoin(material.linejoin),setStrokeStyle(material.color.getStyle()),setLineDash([material.dashSize,material.gapSize]),_context.stroke(),_elemBox.expandByScalar(2*material.linewidth),setLineDash([]))}function renderFace3(v1,v2,v3,uv1,uv2,uv3,element,material){if(_this.info.render.vertices+=3,_this.info.render.faces++,setOpacity(material.opacity),setBlending(material.blending),_v1x=v1.positionScreen.x,_v1y=v1.positionScreen.y,_v2x=v2.positionScreen.x,_v2y=v2.positionScreen.y,_v3x=v3.positionScreen.x,_v3y=v3.positionScreen.y,function drawTriangle(x0,y0,x1,y1,x2,y2){_context.beginPath(),_context.moveTo(x0,y0),_context.lineTo(x1,y1),_context.lineTo(x2,y2),_context.closePath()}(_v1x,_v1y,_v2x,_v2y,_v3x,_v3y),(material instanceof THREE.MeshLambertMaterial||material instanceof THREE.MeshPhongMaterial)&&null===material.map)_diffuseColor.copy(material.color),_emissiveColor.copy(material.emissive),material.vertexColors===THREE.FaceColors&&_diffuseColor.multiply(element.color),_color.copy(_ambientLight),_centroid.copy(v1.positionWorld).add(v2.positionWorld).add(v3.positionWorld).divideScalar(3),function calculateLight(position,normal,color){for(var l=0,ll=_lights.length;l<ll;l++){var light=_lights[l];if(_lightColor.copy(light.color),light instanceof THREE.DirectionalLight){var lightPosition=_vector3.setFromMatrixPosition(light.matrixWorld).normalize();if((amount=normal.dot(lightPosition))<=0)continue;amount*=light.intensity,color.add(_lightColor.multiplyScalar(amount))}else if(light instanceof THREE.PointLight){var amount;lightPosition=_vector3.setFromMatrixPosition(light.matrixWorld);if((amount=normal.dot(_vector3.subVectors(lightPosition,position).normalize()))<=0)continue;if(0==(amount*=0==light.distance?1:1-Math.min(position.distanceTo(lightPosition)/light.distance,1)))continue;amount*=light.intensity,color.add(_lightColor.multiplyScalar(amount))}}}(_centroid,element.normalModel,_color),_color.multiply(_diffuseColor).add(_emissiveColor),!0===material.wireframe?strokePath(_color,material.wireframeLinewidth,material.wireframeLinecap,material.wireframeLinejoin):fillPath(_color);else if(material instanceof THREE.MeshBasicMaterial||material instanceof THREE.MeshLambertMaterial||material instanceof THREE.MeshPhongMaterial){if(null!==material.map)material.map.mapping===THREE.UVMapping&&(_uvs=element.uvs,patternPath(_v1x,_v1y,_v2x,_v2y,_v3x,_v3y,_uvs[uv1].x,_uvs[uv1].y,_uvs[uv2].x,_uvs[uv2].y,_uvs[uv3].x,_uvs[uv3].y,material.map));else null!==material.envMap?material.envMap.mapping===THREE.SphericalReflectionMapping&&(_normal.copy(element.vertexNormalsModel[uv1]).applyMatrix3(_normalViewMatrix),_uv1x=.5*_normal.x+.5,_uv1y=.5*_normal.y+.5,_normal.copy(element.vertexNormalsModel[uv2]).applyMatrix3(_normalViewMatrix),_uv2x=.5*_normal.x+.5,_uv2y=.5*_normal.y+.5,_normal.copy(element.vertexNormalsModel[uv3]).applyMatrix3(_normalViewMatrix),_uv3x=.5*_normal.x+.5,_uv3y=.5*_normal.y+.5,patternPath(_v1x,_v1y,_v2x,_v2y,_v3x,_v3y,_uv1x,_uv1y,_uv2x,_uv2y,_uv3x,_uv3y,material.envMap)):(_color.copy(material.color),material.vertexColors===THREE.FaceColors&&_color.multiply(element.color),!0===material.wireframe?strokePath(_color,material.wireframeLinewidth,material.wireframeLinecap,material.wireframeLinejoin):fillPath(_color))}else material instanceof THREE.MeshNormalMaterial?(_normal.copy(element.normalModel).applyMatrix3(_normalViewMatrix),_color.setRGB(_normal.x,_normal.y,_normal.z).multiplyScalar(.5).addScalar(.5),!0===material.wireframe?strokePath(_color,material.wireframeLinewidth,material.wireframeLinecap,material.wireframeLinejoin):fillPath(_color)):(_color.setRGB(1,1,1),!0===material.wireframe?strokePath(_color,material.wireframeLinewidth,material.wireframeLinecap,material.wireframeLinejoin):fillPath(_color))}function strokePath(color,linewidth,linecap,linejoin){setLineWidth(linewidth),setLineCap(linecap),setLineJoin(linejoin),setStrokeStyle(color.getStyle()),_context.stroke(),_elemBox.expandByScalar(2*linewidth)}function fillPath(color){setFillStyle(color.getStyle()),_context.fill()}function textureToPattern(texture){if(0===texture.version||texture instanceof THREE.CompressedTexture||texture instanceof THREE.DataTexture)return{canvas:void 0,version:texture.version};var image=texture.image;if(!1===image.complete)return{canvas:void 0,version:0};var repeatX=texture.wrapS===THREE.RepeatWrapping||texture.wrapS===THREE.MirroredRepeatWrapping,repeatY=texture.wrapT===THREE.RepeatWrapping||texture.wrapT===THREE.MirroredRepeatWrapping,mirrorX=texture.wrapS===THREE.MirroredRepeatWrapping,mirrorY=texture.wrapT===THREE.MirroredRepeatWrapping,canvas=document.createElement("canvas");canvas.width=image.width*(mirrorX?2:1),canvas.height=image.height*(mirrorY?2:1);var context=canvas.getContext("2d");context.setTransform(1,0,0,-1,0,image.height),context.drawImage(image,0,0),!0===mirrorX&&(context.setTransform(-1,0,0,-1,image.width,image.height),context.drawImage(image,-image.width,0)),!0===mirrorY&&(context.setTransform(1,0,0,1,0,0),context.drawImage(image,0,image.height)),!0===mirrorX&&!0===mirrorY&&(context.setTransform(-1,0,0,1,image.width,0),context.drawImage(image,-image.width,image.height));var repeat="no-repeat";!0===repeatX&&!0===repeatY?repeat="repeat":!0===repeatX?repeat="repeat-x":!0===repeatY&&(repeat="repeat-y");var pattern=_context.createPattern(canvas,repeat);return texture.onUpdate&&texture.onUpdate(texture),{canvas:pattern,version:texture.version}}function patternPath(x0,y0,x1,y1,x2,y2,u0,v0,u1,v1,u2,v2,texture){var pattern=_patterns[texture.id];if(void 0!==pattern&&pattern.version===texture.version||(pattern=textureToPattern(texture),_patterns[texture.id]=pattern),void 0===pattern.canvas)return setFillStyle("rgba( 0, 0, 0, 1)"),void _context.fill();setFillStyle(pattern.canvas);var a,b,c,d,e,f,det,idet,offsetX=texture.offset.x/texture.repeat.x,offsetY=texture.offset.y/texture.repeat.y,width=texture.image.width*texture.repeat.x,height=texture.image.height*texture.repeat.y;u1=(u1+offsetX)*width,v1=(v1+offsetY)*height,u2=(u2+offsetX)*width,v2=(v2+offsetY)*height,x1-=x0,y1-=y0,x2-=x0,y2-=y0,0!==(det=(u1-=u0=(u0+offsetX)*width)*(v2-=v0=(v0+offsetY)*height)-(u2-=u0)*(v1-=v0))&&(e=x0-(a=(v2*x1-v1*x2)*(idet=1/det))*u0-(c=(u1*x2-u2*x1)*idet)*v0,f=y0-(b=(v2*y1-v1*y2)*idet)*u0-(d=(u1*y2-u2*y1)*idet)*v0,_context.save(),_context.transform(a,b,c,d,e,f),_context.fill(),_context.restore())}function expand(v1,v2,pixels){var idet,x=v2.x-v1.x,y=v2.y-v1.y,det=x*x+y*y;0!==det&&(x*=idet=pixels/Math.sqrt(det),y*=idet,v2.x+=x,v2.y+=y,v1.x-=x,v1.y-=y)}function setOpacity(value){_contextGlobalAlpha!==value&&(_context.globalAlpha=value,_contextGlobalAlpha=value)}function setBlending(value){_contextGlobalCompositeOperation!==value&&(value===THREE.NormalBlending?_context.globalCompositeOperation="source-over":value===THREE.AdditiveBlending?_context.globalCompositeOperation="lighter":value===THREE.SubtractiveBlending?_context.globalCompositeOperation="darker":value===THREE.MultiplyBlending&&(_context.globalCompositeOperation="multiply"),_contextGlobalCompositeOperation=value)}function setLineWidth(value){_contextLineWidth!==value&&(_context.lineWidth=value,_contextLineWidth=value)}function setLineCap(value){_contextLineCap!==value&&(_context.lineCap=value,_contextLineCap=value)}function setLineJoin(value){_contextLineJoin!==value&&(_context.lineJoin=value,_contextLineJoin=value)}function setStrokeStyle(value){_contextStrokeStyle!==value&&(_context.strokeStyle=value,_contextStrokeStyle=value)}function setFillStyle(value){_contextFillStyle!==value&&(_context.fillStyle=value,_contextFillStyle=value)}function setLineDash(value){_contextLineDash.length!==value.length&&(_context.setLineDash(value),_contextLineDash=value)}void 0===_context.setLineDash&&(_context.setLineDash=function(){}),this.domElement=_canvas,this.autoClear=!0,this.sortObjects=!0,this.sortElements=!0,this.info={render:{vertices:0,faces:0}},this.supportsVertexTextures=function(){},this.setFaceCulling=function(){},this.getContext=function(){return _context},this.getContextAttributes=function(){return _context.getContextAttributes()},this.getPixelRatio=function(){return _pixelRatio},this.setPixelRatio=function(value){void 0!==value&&(_pixelRatio=value)},this.setSize=function(width,height,updateStyle){_canvasWidth=width*_pixelRatio,_canvasHeight=height*_pixelRatio,_canvas.width=_canvasWidth,_canvas.height=_canvasHeight,_canvasWidthHalf=Math.floor(_canvasWidth/2),_canvasHeightHalf=Math.floor(_canvasHeight/2),!1!==updateStyle&&(_canvas.style.width=width+"px",_canvas.style.height=height+"px"),_clipBox.min.set(-_canvasWidthHalf,-_canvasHeightHalf),_clipBox.max.set(_canvasWidthHalf,_canvasHeightHalf),_clearBox.min.set(-_canvasWidthHalf,-_canvasHeightHalf),_clearBox.max.set(_canvasWidthHalf,_canvasHeightHalf),_contextGlobalAlpha=1,_contextGlobalCompositeOperation=0,_contextStrokeStyle=null,_contextFillStyle=null,_contextLineWidth=null,_contextLineCap=null,_contextLineJoin=null,this.setViewport(0,0,width,height)},this.setViewport=function(x,y,width,height){_viewportX=x*_pixelRatio,_viewportY=y*_pixelRatio,_viewportWidth=width*_pixelRatio,_viewportHeight=height*_pixelRatio},this.setScissor=function(){},this.setScissorTest=function(){},this.setClearColor=function(color,alpha){_clearColor.set(color),_clearAlpha=void 0!==alpha?alpha:1,_clearBox.min.set(-_canvasWidthHalf,-_canvasHeightHalf),_clearBox.max.set(_canvasWidthHalf,_canvasHeightHalf)},this.setClearColorHex=function(hex,alpha){console.warn("THREE.CanvasRenderer: .setClearColorHex() is being removed. Use .setClearColor() instead."),this.setClearColor(hex,alpha)},this.getClearColor=function(){return _clearColor},this.getClearAlpha=function(){return _clearAlpha},this.getMaxAnisotropy=function(){return 0},this.clear=function(){!1===_clearBox.isEmpty()&&(_clearBox.intersect(_clipBox),_clearBox.expandByScalar(2),_clearBox.min.x=_clearBox.min.x+_canvasWidthHalf,_clearBox.min.y=-_clearBox.min.y+_canvasHeightHalf,_clearBox.max.x=_clearBox.max.x+_canvasWidthHalf,_clearBox.max.y=-_clearBox.max.y+_canvasHeightHalf,_clearAlpha<1&&_context.clearRect(0|_clearBox.min.x,0|_clearBox.max.y,_clearBox.max.x-_clearBox.min.x|0,_clearBox.min.y-_clearBox.max.y|0),_clearAlpha>0&&(setBlending(THREE.NormalBlending),setOpacity(1),setFillStyle("rgba("+Math.floor(255*_clearColor.r)+","+Math.floor(255*_clearColor.g)+","+Math.floor(255*_clearColor.b)+","+_clearAlpha+")"),_context.fillRect(0|_clearBox.min.x,0|_clearBox.max.y,_clearBox.max.x-_clearBox.min.x|0,_clearBox.min.y-_clearBox.max.y|0)),_clearBox.makeEmpty())},this.clearColor=function(){},this.clearDepth=function(){},this.clearStencil=function(){},this.render=function(scene,camera){if(camera instanceof THREE.Camera!=!1){var background=scene.background;background&&background.isColor?(setFillStyle("rgb("+Math.floor(255*background.r)+","+Math.floor(255*background.g)+","+Math.floor(255*background.b)+")"),_context.fillRect(0,0,_canvasWidth,_canvasHeight)):!0===this.autoClear&&this.clear(),_this.info.render.vertices=0,_this.info.render.faces=0,_context.setTransform(_viewportWidth/_canvasWidth,0,0,-_viewportHeight/_canvasHeight,_viewportX,_canvasHeight-_viewportY),_context.translate(_canvasWidthHalf,_canvasHeightHalf),_renderData=_projector.projectScene(scene,camera,this.sortObjects,this.sortElements),_elements=_renderData.elements,_lights=_renderData.lights,camera,_normalViewMatrix.getNormalMatrix(camera.matrixWorldInverse),function calculateLights(){_ambientLight.setRGB(0,0,0),_directionalLights.setRGB(0,0,0),_pointLights.setRGB(0,0,0);for(var l=0,ll=_lights.length;l<ll;l++){var light=_lights[l],lightColor=light.color;light instanceof THREE.AmbientLight?_ambientLight.add(lightColor):light instanceof THREE.DirectionalLight?_directionalLights.add(lightColor):light instanceof THREE.PointLight&&_pointLights.add(lightColor)}}();for(var e=0,el=_elements.length;e<el;e++){var element=_elements[e],material=element.material;if(void 0!==material&&0!==material.opacity){if(_elemBox.makeEmpty(),element instanceof THREE.RenderableSprite)(_v1=element).x*=_canvasWidthHalf,_v1.y*=_canvasHeightHalf,renderSprite(_v1,element,material);else if(element instanceof THREE.RenderableLine)_v1=element.v1,_v2=element.v2,_v1.positionScreen.x*=_canvasWidthHalf,_v1.positionScreen.y*=_canvasHeightHalf,_v2.positionScreen.x*=_canvasWidthHalf,_v2.positionScreen.y*=_canvasHeightHalf,_elemBox.setFromPoints([_v1.positionScreen,_v2.positionScreen]),!0===_clipBox.intersectsBox(_elemBox)&&renderLine(_v1,_v2,element,material);else if(element instanceof THREE.RenderableFace){if(_v1=element.v1,_v2=element.v2,_v3=element.v3,_v1.positionScreen.z<-1||_v1.positionScreen.z>1)continue;if(_v2.positionScreen.z<-1||_v2.positionScreen.z>1)continue;if(_v3.positionScreen.z<-1||_v3.positionScreen.z>1)continue;_v1.positionScreen.x*=_canvasWidthHalf,_v1.positionScreen.y*=_canvasHeightHalf,_v2.positionScreen.x*=_canvasWidthHalf,_v2.positionScreen.y*=_canvasHeightHalf,_v3.positionScreen.x*=_canvasWidthHalf,_v3.positionScreen.y*=_canvasHeightHalf,material.overdraw>0&&(expand(_v1.positionScreen,_v2.positionScreen,material.overdraw),expand(_v2.positionScreen,_v3.positionScreen,material.overdraw),expand(_v3.positionScreen,_v1.positionScreen,material.overdraw)),_elemBox.setFromPoints([_v1.positionScreen,_v2.positionScreen,_v3.positionScreen]),!0===_clipBox.intersectsBox(_elemBox)&&renderFace3(_v1,_v2,_v3,0,1,2,element,material)}_clearBox.union(_elemBox)}}_context.setTransform(1,0,0,1,0,0)}else console.error("THREE.CanvasRenderer.render: camera is not an instance of THREE.Camera.")}};