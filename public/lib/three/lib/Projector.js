THREE.RenderableObject=function(){this.id=0,this.object=null,this.z=0,this.renderOrder=0},THREE.RenderableFace=function(){this.id=0,this.v1=new THREE.RenderableVertex,this.v2=new THREE.RenderableVertex,this.v3=new THREE.RenderableVertex,this.normalModel=new THREE.Vector3,this.vertexNormalsModel=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3],this.vertexNormalsLength=0,this.color=new THREE.Color,this.material=null,this.uvs=[new THREE.Vector2,new THREE.Vector2,new THREE.Vector2],this.z=0,this.renderOrder=0},THREE.RenderableVertex=function(){this.position=new THREE.Vector3,this.positionWorld=new THREE.Vector3,this.positionScreen=new THREE.Vector4,this.visible=!0},THREE.RenderableVertex.prototype.copy=function(vertex){this.positionWorld.copy(vertex.positionWorld),this.positionScreen.copy(vertex.positionScreen)},THREE.RenderableLine=function(){this.id=0,this.v1=new THREE.RenderableVertex,this.v2=new THREE.RenderableVertex,this.vertexColors=[new THREE.Color,new THREE.Color],this.material=null,this.z=0,this.renderOrder=0},THREE.RenderableSprite=function(){this.id=0,this.object=null,this.x=0,this.y=0,this.z=0,this.rotation=0,this.scale=new THREE.Vector2,this.material=null,this.renderOrder=0},THREE.Projector=function(){var _object,_objectCount,_vertex,_vertexCount,_face,_faceCount,_line,_lineCount,_sprite,_spriteCount,_modelMatrix,_objectPool=[],_objectPoolLength=0,_vertexPool=[],_vertexPoolLength=0,_facePool=[],_facePoolLength=0,_linePool=[],_linePoolLength=0,_spritePool=[],_spritePoolLength=0,_renderData={objects:[],lights:[],elements:[]},_vector3=new THREE.Vector3,_vector4=new THREE.Vector4,_clipBox=new THREE.Box3(new THREE.Vector3(-1,-1,-1),new THREE.Vector3(1,1,1)),_boundingBox=new THREE.Box3,_points3=new Array(3),_viewMatrix=(new Array(4),new THREE.Matrix4),_viewProjectionMatrix=new THREE.Matrix4,_modelViewProjectionMatrix=new THREE.Matrix4,_normalMatrix=new THREE.Matrix3,_frustum=new THREE.Frustum,_clippedVertex1PositionScreen=new THREE.Vector4,_clippedVertex2PositionScreen=new THREE.Vector4;this.projectVector=function(vector,camera){console.warn("THREE.Projector: .projectVector() is now vector.project()."),vector.project(camera)},this.unprojectVector=function(vector,camera){console.warn("THREE.Projector: .unprojectVector() is now vector.unproject()."),vector.unproject(camera)},this.pickingRay=function(vector,camera){console.error("THREE.Projector: .pickingRay() is now raycaster.setFromCamera().")};var renderList=new function(){var normals=[],uvs=[],object=null,material=null,normalMatrix=new THREE.Matrix3;function projectVertex(vertex){var position=vertex.position,positionWorld=vertex.positionWorld,positionScreen=vertex.positionScreen;positionWorld.copy(position).applyMatrix4(_modelMatrix),positionScreen.copy(positionWorld).applyMatrix4(_viewProjectionMatrix);var invW=1/positionScreen.w;positionScreen.x*=invW,positionScreen.y*=invW,positionScreen.z*=invW,vertex.visible=positionScreen.x>=-1&&positionScreen.x<=1&&positionScreen.y>=-1&&positionScreen.y<=1&&positionScreen.z>=-1&&positionScreen.z<=1}function checkTriangleVisibility(v1,v2,v3){return!0===v1.visible||!0===v2.visible||!0===v3.visible||(_points3[0]=v1.positionScreen,_points3[1]=v2.positionScreen,_points3[2]=v3.positionScreen,_clipBox.intersectsBox(_boundingBox.setFromPoints(_points3)))}function checkBackfaceCulling(v1,v2,v3){return(v3.positionScreen.x-v1.positionScreen.x)*(v2.positionScreen.y-v1.positionScreen.y)-(v3.positionScreen.y-v1.positionScreen.y)*(v2.positionScreen.x-v1.positionScreen.x)<0}return{setObject:function setObject(value){material=(object=value).material,normalMatrix.getNormalMatrix(object.matrixWorld),normals.length=0,uvs.length=0},projectVertex:projectVertex,checkTriangleVisibility:checkTriangleVisibility,checkBackfaceCulling:checkBackfaceCulling,pushVertex:function pushVertex(x,y,z){(_vertex=getNextVertexInPool()).position.set(x,y,z),projectVertex(_vertex)},pushNormal:function pushNormal(x,y,z){normals.push(x,y,z)},pushUv:function pushUv(x,y){uvs.push(x,y)},pushLine:function pushLine(a,b){var v1=_vertexPool[a],v2=_vertexPool[b];(_line=getNextLineInPool()).id=object.id,_line.v1.copy(v1),_line.v2.copy(v2),_line.z=(v1.positionScreen.z+v2.positionScreen.z)/2,_line.renderOrder=object.renderOrder,_line.material=object.material,_renderData.elements.push(_line)},pushTriangle:function pushTriangle(a,b,c){var v1=_vertexPool[a],v2=_vertexPool[b],v3=_vertexPool[c];if(!1!==checkTriangleVisibility(v1,v2,v3)&&(material.side===THREE.DoubleSide||!0===checkBackfaceCulling(v1,v2,v3))){(_face=getNextFaceInPool()).id=object.id,_face.v1.copy(v1),_face.v2.copy(v2),_face.v3.copy(v3),_face.z=(v1.positionScreen.z+v2.positionScreen.z+v3.positionScreen.z)/3,_face.renderOrder=object.renderOrder,_face.normalModel.fromArray(normals,3*a),_face.normalModel.applyMatrix3(normalMatrix).normalize();for(var i=0;i<3;i++){var normal=_face.vertexNormalsModel[i];normal.fromArray(normals,3*arguments[i]),normal.applyMatrix3(normalMatrix).normalize(),_face.uvs[i].fromArray(uvs,2*arguments[i])}_face.vertexNormalsLength=3,_face.material=object.material,_renderData.elements.push(_face)}}}};function getNextVertexInPool(){if(_vertexCount===_vertexPoolLength){var vertex=new THREE.RenderableVertex;return _vertexPool.push(vertex),_vertexPoolLength++,_vertexCount++,vertex}return _vertexPool[_vertexCount++]}function getNextFaceInPool(){if(_faceCount===_facePoolLength){var face=new THREE.RenderableFace;return _facePool.push(face),_facePoolLength++,_faceCount++,face}return _facePool[_faceCount++]}function getNextLineInPool(){if(_lineCount===_linePoolLength){var line=new THREE.RenderableLine;return _linePool.push(line),_linePoolLength++,_lineCount++,line}return _linePool[_lineCount++]}function getNextSpriteInPool(){if(_spriteCount===_spritePoolLength){var sprite=new THREE.RenderableSprite;return _spritePool.push(sprite),_spritePoolLength++,_spriteCount++,sprite}return _spritePool[_spriteCount++]}function painterSort(a,b){return a.renderOrder!==b.renderOrder?a.renderOrder-b.renderOrder:a.z!==b.z?b.z-a.z:a.id!==b.id?a.id-b.id:0}function clipLine(s1,s2){var alpha1=0,alpha2=1,bc1near=s1.z+s1.w,bc2near=s2.z+s2.w,bc1far=-s1.z+s1.w,bc2far=-s2.z+s2.w;return bc1near>=0&&bc2near>=0&&bc1far>=0&&bc2far>=0||!(bc1near<0&&bc2near<0||bc1far<0&&bc2far<0)&&(bc1near<0?alpha1=Math.max(alpha1,bc1near/(bc1near-bc2near)):bc2near<0&&(alpha2=Math.min(alpha2,bc1near/(bc1near-bc2near))),bc1far<0?alpha1=Math.max(alpha1,bc1far/(bc1far-bc2far)):bc2far<0&&(alpha2=Math.min(alpha2,bc1far/(bc1far-bc2far))),!(alpha2<alpha1)&&(s1.lerp(s2,alpha1),s2.lerp(s1,1-alpha2),!0))}this.projectScene=function(scene,camera,sortObjects,sortElements){function addObject(object){(_object=function getNextObjectInPool(){if(_objectCount===_objectPoolLength){var object=new THREE.RenderableObject;return _objectPool.push(object),_objectPoolLength++,_objectCount++,object}return _objectPool[_objectCount++]}()).id=object.id,_object.object=object,_vector3.setFromMatrixPosition(object.matrixWorld),_vector3.applyMatrix4(_viewProjectionMatrix),_object.z=_vector3.z,_object.renderOrder=object.renderOrder,_renderData.objects.push(_object)}_faceCount=0,_lineCount=0,_spriteCount=0,_renderData.elements.length=0,!0===scene.autoUpdate&&scene.updateMatrixWorld(),null===camera.parent&&camera.updateMatrixWorld(),_viewMatrix.copy(camera.matrixWorldInverse.getInverse(camera.matrixWorld)),_viewProjectionMatrix.multiplyMatrices(camera.projectionMatrix,_viewMatrix),_frustum.setFromMatrix(_viewProjectionMatrix),_objectCount=0,_renderData.objects.length=0,_renderData.lights.length=0,scene.traverseVisible((function(object){if(object instanceof THREE.Light)_renderData.lights.push(object);else if(object instanceof THREE.Mesh||object instanceof THREE.Line){if(!1===object.material.visible)return;if(!0===object.frustumCulled&&!1===_frustum.intersectsObject(object))return;addObject(object)}else if(object instanceof THREE.Sprite){if(!1===object.material.visible)return;if(!0===object.frustumCulled&&!1===_frustum.intersectsSprite(object))return;addObject(object)}})),!0===sortObjects&&_renderData.objects.sort(painterSort);for(var o=0,ol=_renderData.objects.length;o<ol;o++){var object=_renderData.objects[o].object,geometry=object.geometry;if(renderList.setObject(object),_modelMatrix=object.matrixWorld,_vertexCount=0,object instanceof THREE.Mesh){if(geometry instanceof THREE.BufferGeometry){var attributes=geometry.attributes,groups=geometry.groups;if(void 0===attributes.position)continue;for(var i=0,l=(positions=attributes.position.array).length;i<l;i+=3)renderList.pushVertex(positions[i],positions[i+1],positions[i+2]);if(void 0!==attributes.normal){var normals=attributes.normal.array;for(i=0,l=normals.length;i<l;i+=3)renderList.pushNormal(normals[i],normals[i+1],normals[i+2])}if(void 0!==attributes.uv){var uvs=attributes.uv.array;for(i=0,l=uvs.length;i<l;i+=2)renderList.pushUv(uvs[i],uvs[i+1])}if(null!==geometry.index){var indices=geometry.index.array;if(groups.length>0)for(var g=0;g<groups.length;g++){var group=groups[g];for(i=group.start,l=group.start+group.count;i<l;i+=3)renderList.pushTriangle(indices[i],indices[i+1],indices[i+2])}else for(i=0,l=indices.length;i<l;i+=3)renderList.pushTriangle(indices[i],indices[i+1],indices[i+2])}else for(i=0,l=positions.length/3;i<l;i+=3)renderList.pushTriangle(i,i+1,i+2)}else if(geometry instanceof THREE.Geometry){var vertices=geometry.vertices,faces=geometry.faces,faceVertexUvs=geometry.faceVertexUvs[0];_normalMatrix.getNormalMatrix(_modelMatrix);for(var material=object.material,isFaceMaterial=material instanceof THREE.MultiMaterial,objectMaterials=!0===isFaceMaterial?object.material:null,v=0,vl=vertices.length;v<vl;v++){var vertex=vertices[v];if(_vector3.copy(vertex),!0===material.morphTargets)for(var morphTargets=geometry.morphTargets,morphInfluences=object.morphTargetInfluences,t=0,tl=morphTargets.length;t<tl;t++){var influence=morphInfluences[t];if(0!==influence){var targetVertex=morphTargets[t].vertices[v];_vector3.x+=(targetVertex.x-vertex.x)*influence,_vector3.y+=(targetVertex.y-vertex.y)*influence,_vector3.z+=(targetVertex.z-vertex.z)*influence}}renderList.pushVertex(_vector3.x,_vector3.y,_vector3.z)}for(var f=0,fl=faces.length;f<fl;f++){var face=faces[f];if(void 0!==(material=!0===isFaceMaterial?objectMaterials.materials[face.materialIndex]:object.material)){var side=material.side,v1=_vertexPool[face.a],v2=_vertexPool[face.b],v3=_vertexPool[face.c];if(!1!==renderList.checkTriangleVisibility(v1,v2,v3)){var visible=renderList.checkBackfaceCulling(v1,v2,v3);if(side!==THREE.DoubleSide){if(side===THREE.FrontSide&&!1===visible)continue;if(side===THREE.BackSide&&!0===visible)continue}(_face=getNextFaceInPool()).id=object.id,_face.v1.copy(v1),_face.v2.copy(v2),_face.v3.copy(v3),_face.normalModel.copy(face.normal),!1!==visible||side!==THREE.BackSide&&side!==THREE.DoubleSide||_face.normalModel.negate(),_face.normalModel.applyMatrix3(_normalMatrix).normalize();for(var faceVertexNormals=face.vertexNormals,n=0,nl=Math.min(faceVertexNormals.length,3);n<nl;n++){var normalModel=_face.vertexNormalsModel[n];normalModel.copy(faceVertexNormals[n]),!1!==visible||side!==THREE.BackSide&&side!==THREE.DoubleSide||normalModel.negate(),normalModel.applyMatrix3(_normalMatrix).normalize()}_face.vertexNormalsLength=faceVertexNormals.length;var vertexUvs=faceVertexUvs[f];if(void 0!==vertexUvs)for(var u=0;u<3;u++)_face.uvs[u].copy(vertexUvs[u]);_face.color=face.color,_face.material=material,_face.z=(v1.positionScreen.z+v2.positionScreen.z+v3.positionScreen.z)/3,_face.renderOrder=object.renderOrder,_renderData.elements.push(_face)}}}}}else if(object instanceof THREE.Line){if(geometry instanceof THREE.BufferGeometry){if(void 0!==(attributes=geometry.attributes).position){var positions;for(i=0,l=(positions=attributes.position.array).length;i<l;i+=3)renderList.pushVertex(positions[i],positions[i+1],positions[i+2]);if(null!==geometry.index)for(i=0,l=(indices=geometry.index.array).length;i<l;i+=2)renderList.pushLine(indices[i],indices[i+1]);else{var step=object instanceof THREE.LineSegments?2:1;for(i=0,l=positions.length/3-1;i<l;i+=step)renderList.pushLine(i,i+1)}}}else if(geometry instanceof THREE.Geometry){if(_modelViewProjectionMatrix.multiplyMatrices(_viewProjectionMatrix,_modelMatrix),0===(vertices=object.geometry.vertices).length)continue;(v1=getNextVertexInPool()).positionScreen.copy(vertices[0]).applyMatrix4(_modelViewProjectionMatrix);for(step=object instanceof THREE.LineSegments?2:1,v=1,vl=vertices.length;v<vl;v++)(v1=getNextVertexInPool()).positionScreen.copy(vertices[v]).applyMatrix4(_modelViewProjectionMatrix),(v+1)%step>0||(v2=_vertexPool[_vertexCount-2],_clippedVertex1PositionScreen.copy(v1.positionScreen),_clippedVertex2PositionScreen.copy(v2.positionScreen),!0===clipLine(_clippedVertex1PositionScreen,_clippedVertex2PositionScreen)&&(_clippedVertex1PositionScreen.multiplyScalar(1/_clippedVertex1PositionScreen.w),_clippedVertex2PositionScreen.multiplyScalar(1/_clippedVertex2PositionScreen.w),(_line=getNextLineInPool()).id=object.id,_line.v1.positionScreen.copy(_clippedVertex1PositionScreen),_line.v2.positionScreen.copy(_clippedVertex2PositionScreen),_line.z=Math.max(_clippedVertex1PositionScreen.z,_clippedVertex2PositionScreen.z),_line.renderOrder=object.renderOrder,_line.material=object.material,object.material.vertexColors===THREE.VertexColors&&(_line.vertexColors[0].copy(object.geometry.colors[v]),_line.vertexColors[1].copy(object.geometry.colors[v-1])),_renderData.elements.push(_line)))}}else if(object instanceof THREE.Sprite){_vector4.set(_modelMatrix.elements[12],_modelMatrix.elements[13],_modelMatrix.elements[14],1),_vector4.applyMatrix4(_viewProjectionMatrix);var invW=1/_vector4.w;_vector4.z*=invW,_vector4.z>=-1&&_vector4.z<=1&&((_sprite=getNextSpriteInPool()).id=object.id,_sprite.x=_vector4.x*invW,_sprite.y=_vector4.y*invW,_sprite.z=_vector4.z,_sprite.renderOrder=object.renderOrder,_sprite.object=object,_sprite.rotation=object.rotation,_sprite.scale.x=object.scale.x*Math.abs(_sprite.x-(_vector4.x+camera.projectionMatrix.elements[0])/(_vector4.w+camera.projectionMatrix.elements[12])),_sprite.scale.y=object.scale.y*Math.abs(_sprite.y-(_vector4.y+camera.projectionMatrix.elements[5])/(_vector4.w+camera.projectionMatrix.elements[13])),_sprite.material=object.material,_renderData.elements.push(_sprite))}}return!0===sortElements&&_renderData.elements.sort(painterSort),_renderData}};